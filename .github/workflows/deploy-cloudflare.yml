name: Cloudflare部署

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 安装wrangler
        run: npm install -g wrangler

      - name: 前端构建
        run: |
          cd src/frontend
          npm install
          npm run build
          cd ../..

      - name: 后端构建
        run: |
          cd src/backend
          npm install
          cd ../..

      - name: 部署后端到Workers
        run: |
          cd src/backend
          wrangler deploy \
            --account-id ${{ secrets.CLOUDFLARE_ACCOUNT_ID }} \
            --api-token ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cd ../..

      - name: 部署前端到Pages
        run: |
          cd src/frontend
          wrangler pages publish dist/ \
            --project-name=pcb-impedance-calculator \
            --account-id ${{ secrets.CLOUDFLARE_ACCOUNT_ID }} \
            --api-token ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cd ../..

      - name: 部署完成通知
        if: success()
        run: |
          echo "✅ 部署成功!"
          echo "前端: https://pcb-impedance-calculator.pages.dev"
          echo "后端: https://api.pcb-impedance-calculator.workers.dev"

      - name: 部署失败通知
        if: failure()
        run: |
          echo "❌ 部署失败!"
          exit 1
